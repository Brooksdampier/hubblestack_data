#
# explanation for the following checks will be written here
#
#

grep:
  blacklist:
    centos7-meltdown-disabled:
      data:
        CentOS Linux-7:
          - '/sys/kernel/debug/x86/pti_enabled':
              tag: 'CVE-2017-5754-fix-enabled'
              pattern: '1'
              match_on_file_missing: True
      description: 'Check if CVE-2017-5754 mitigation has NOT been disabled in Centos 7.'
    amazonlinux-meltdown-disabled:
      data:
        'Amazon Linux*':
          - '/sys/devices/system/cpu/vulnerabilities/meltdown':
              tag: 'CVE-2017-5754-fix-enabled'
              pattern: 'Vulnerable'
              match_on_file_missing: True
      description: 'Check if CVE-2017-5754 mitigation has NOT been disabled in Amazon Linux.'
    linux-meltdown-disabled:
      data:
        '*Ubuntu*,*CoreOS*':
          - '/proc/cmdline':
              tag: 'CVE-2017-5754-fix-enabled'
              pattern: '.*\\K\(?<=\ \)\(nopti|pti=off\)\(?=\ .*\)'
              match_output: (nopti|pti=off)
              match_output_regex: True
              grep_args:
                - '-o'
                - '-P'
              match_on_file_missing: False
      description: 'Check if CVE-2017-5754 mitigation has NOT been disabled.'
  whitelist:
    centos6-meltdown-disabled:
      data:
        CentOS-6:
          - '/var/log/dmesg':
              tag: 'CVE-2017-5754-fix-enabled'
              pattern: 'Kernel page table isolation enabled'
              match_on_file_missing: False
      description: 'Check for CVE-2017-5754 mitigation in Centos 6.'
    linux-meltdown-present:
      data:
        '*Ubuntu*,*CoreOS*': 
          - '/proc/cpuinfo':
              tag: 'CVE-2017-5754-fix-present'
              pattern: '^flags\\s*:.*\\K\(?<=\ \)\(pti|kaiser\)\(?=\ .*\)'
              match_output: (pti|kaiser)
              match_output_regex: True
              grep_args:
                - '-o'
                - '-P'
              match_on_file_missing: False
      description: 'Check for CVE-2017-5754 mitigation presence.'
    check_cpuinfo_for_pcid:
      data:
        '*':
          - '/proc/cpuinfo':
              tag: 'Meltdown/Spectre/pcid'
              pattern: 'flags'
              match_output: ' pcid'
              grep_args:
                - '-i'
      description: 'Check the /proc/cpuinfo file for the pcid flag.'

stat:
  centos7-meltdown-present:
    data:
      CentOS Linux-7:
        - '/sys/kernel/debug/x86/pti_enabled':
            tag: 'CVE-2017-5754-fix-present'
            user: root
            uid: 0
            group: root
            gid: 0
    description: 'Check for CVE-2017-5754 mitigation presence in Centos 7.'
  amazonlinux-meltdown-present:
    data:
      'Amazon Linux*':
          - '/sys/devices/system/cpu/vulnerabilities/meltdown':
             tag: 'CVE-2017-5754-fix-present'
             user: root
             uid: 0
             group: root
             gid: 0
    description: 'Check for CVE-2017-5754 mitigation presence in Amazon Linux.'
